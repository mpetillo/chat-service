<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Real-Time Chat</title>
    <style>
      body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; }
      .container {
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        height: 100vh; 
        overflow: hidden; 
      }

      #top-forms {
        background: #f5f5f5; 
        padding: 1rem; 
        border-bottom: 1px solid #ccc;
      }
      #top-forms form { margin: 0.5rem 0; display: none; }
      #top-forms input { margin-right: 0.5rem; }

      #createAccountForm.active,
      #loginForm.active {
        display: block;
      }

      #link-container {
        margin-top: 1rem;
      }
      #link-container a {
        color: blue;
        cursor: pointer;
        text-decoration: underline;
        margin-right: 1rem;
      }

      #chat-section {
        flex: 1; 
        display: flex; 
        overflow: hidden;
      }

      #sidebar {
        width: 200px; 
        border-right: 1px solid #ccc; 
        background: #f7f7f7; 
        padding: 1rem; 
        box-sizing: border-box;
        overflow-y: auto;
      }
      #sidebar h3 {
        margin-top: 0;
      }
      #user-list {
        list-style-type: none; 
        padding: 0; 
        margin: 0;
      }
      #user-list li {
        margin: 0.5rem 0; 
        padding: 0.5rem; 
        background: #eaeaea; 
        border-radius: 3px;
      }

      #message-area {
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between;
      }
      #messages { 
        list-style-type: none; 
        margin: 0; 
        padding: 0; 
        flex-grow: 1; 
        overflow-y: auto; 
      }
      #messages > li { padding: 0.5rem 1rem; }
      #messages > li:nth-child(odd) { background: #efefef; }

      #form { 
        background: rgba(0, 0, 0, 0.15); 
        padding: 0.25rem; 
        display: flex; 
        height: 3rem; 
        box-sizing: border-box; 
        backdrop-filter: blur(10px); 
      }
      #input { 
        border: none; 
        padding: 0 1rem; 
        flex-grow: 1; 
        border-radius: 2rem; 
        margin: 0.25rem; 
      }
      #input:focus { outline: none; }
      #form > button { 
        background: #333; 
        border: none; 
        padding: 0 1rem; 
        margin: 0.25rem; 
        border-radius: 3px; 
        outline: none; 
        color: #fff; 
      }

      #chat-section, #form {
        display: none;
      }
      #chat-section.active, #form.active {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="top-forms">
        <h2>Welcome to the Chat!</h2>
        <form id="loginForm" class="active">
          <input type="text" id="login-username" placeholder="Username">
          <input type="password" id="login-password" placeholder="Password">
          <button type="submit">Login</button>
          <div id="loginMessage" style="color: red;"></div>
        </form>

        <form id="createAccountForm">
          <input type="text" id="reg-username" placeholder="Username">
          <input type="password" id="reg-password" placeholder="Password">
          <button type="submit">Create Account</button>
          <div id="registrationMessage" style="color: green;"></div>
        </form>

        <div id="link-container">
          <a id="showLoginLink" style="display:none;">Already have an account? Log in</a>
          <a id="showCreateAccountLink">Don't have an account? Create one</a>
        </div>
      </div>

      <div id="chat-section">
        <div id="sidebar">
          <h3>Online Users</h3>
          <ul id="user-list"></ul>
        </div>
        <div id="message-area">
          <ul id="messages"></ul>
          <form id="form" action="">
            <input id="input" autocomplete="off" placeholder="Type a message..."/><button>Send</button>
          </form>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const createAccountForm = document.getElementById('createAccountForm');
      const loginForm = document.getElementById('loginForm');
      const registrationMessage = document.getElementById('registrationMessage');
      const loginMessage = document.getElementById('loginMessage');

      const regUsername = document.getElementById('reg-username');
      const regPassword = document.getElementById('reg-password');
      const loginUsername = document.getElementById('login-username');
      const loginPassword = document.getElementById('login-password');

      const messages = document.getElementById('messages');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const chatSection = document.getElementById('chat-section');
      const userList = document.getElementById('user-list');

      const topForms = document.getElementById('top-forms');
      const showLoginLink = document.getElementById('showLoginLink');
      const showCreateAccountLink = document.getElementById('showCreateAccountLink');

      showCreateAccountLink.addEventListener('click', () => {
        loginForm.classList.remove('active');
        createAccountForm.classList.add('active');
        showCreateAccountLink.style.display = 'none';
        showLoginLink.style.display = 'inline';
      });

      showLoginLink.addEventListener('click', () => {
        createAccountForm.classList.remove('active');
        loginForm.classList.add('active');
        showLoginLink.style.display = 'none';
        showCreateAccountLink.style.display = 'inline';
        registrationMessage.textContent = '';
      });

      createAccountForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = regUsername.value.trim();
        const pass = regPassword.value.trim();
        if (user && pass) {
          socket.emit('createaccount', user, pass);
        }
      });

      socket.on('registrationError', (msg) => {
        registrationMessage.style.color = 'red';
        registrationMessage.textContent = msg;
      });

      socket.on('registrationSuccess', (msg) => {
        registrationMessage.style.color = 'green';
        registrationMessage.textContent = msg;
      });

      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = loginUsername.value.trim();
        const pass = loginPassword.value.trim();
        if (user && pass) {
          socket.emit('login', user, pass);
        }
      });

      socket.on('loginError', (msg) => {
        loginMessage.style.color = 'red';
        loginMessage.textContent = msg;
      });

      socket.on('loginSuccess', (msg) => {
        loginMessage.style.color = 'green';
        loginMessage.textContent = msg;
        chatSection.classList.add('active');
        form.classList.add('active');
        topForms.style.display = 'none';
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit('chat message', input.value);
          input.value = '';
        }
      });

      // Now 'msg' is an object { username: '', message: '' }
      socket.on('chat message', (data) => {
        const item = document.createElement('li');
        item.textContent = data.username + ': ' + data.message;
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
      });

      socket.on('onlineUsers', (users) => {
        userList.innerHTML = '';
        users.forEach((user) => {
          const li = document.createElement('li');
          li.textContent = user;
          userList.appendChild(li);
        });
      });
    </script>
  </body>
</html>
